<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kriya's Poem Verse</title>
  <style>
    body {
      margin:0; padding:0; 
      font-family: 'Georgia', serif; 
      background:#fdfdfd; color:#222;
      overflow-x:hidden;
    }
    .card {
      max-width:600px; margin:40px auto; padding:20px;
      background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
      text-align:center;
    }
    .tabs { display:flex; justify-content:center; margin-top:16px; }
    .tab { flex:1; padding:10px; cursor:pointer; background:#eee; border-radius:8px 8px 0 0; }
    .tab.active { background:#d0e6ff; font-weight:bold; }
    .section { display:none; padding:15px; text-align:left; }
    .section.active { display:block; }
    textarea { width:100%; min-height:120px; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
    .btn { margin:8px; padding:8px 16px; border:none; border-radius:6px; background:#0a5bd3; color:white; cursor:pointer; }
    .btn:hover { background:#0849a8; }
    .poem { border:1px solid #ccc; border-radius:10px; padding:12px; margin:12px 0; background:#f9f9f9; cursor:pointer; transition:0.2s; }
    .poem:hover { background:#eef6ff; }
    .meta { font-size:0.85em; color:#666; margin-top:8px; }
    .delete, .edit {
      background:none; border:none; color:#c00; cursor:pointer; font-size:0.9em; margin-right:8px;
    }
    .edit { color:#0077cc; }
    .empty { text-align:center; padding:20px; color:#777; }

    /* Modal */
    #poemModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #poemModal .inner { background:#fff; padding:20px; border-radius:12px; max-width:500px; width:90%; }
    #modalClose { float:right; cursor:pointer; font-weight:bold; }

    /* Floating hearts */
    #heartsLayer {
      position:fixed; top:0; left:0; width:100%; height:100%; 
      pointer-events:none; overflow:hidden; z-index:0;
    }
    .heart {
      position:absolute; animation: floatUp 7s linear forwards;
    }
    @keyframes floatUp {
      0% { transform:translateY(0) rotate(0deg); opacity:1; }
      100% { transform:translateY(-120vh) rotate(360deg); opacity:0; }
    }

    /* Romantic welcome */
    #welcomeMessage {
      font-size:1.2em;
      color:#d63384;
      margin:15px 0;
      opacity:0;
      animation: fadeIn 2s ease forwards;
      font-family: "Georgia", cursive;
    }
    @keyframes fadeIn {
      to { opacity:1; }
    }
  </style>
</head>
<body>
  <div id="heartsLayer"></div>

  <div class="card" id="loginCard">
    <h2>Login to Poem Verse</h2>
    <input id="email" type="email" placeholder="Email" style="width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc;">
    <input id="password" type="password" placeholder="Password" style="width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc;">
    <button class="btn" id="loginBtn">Login</button>
    <div id="loginError" style="color:red; margin-top:8px;"></div>
  </div>

  <div class="card" id="appCard" style="display:none;">
    <h2>Kriya's Poem Verse</h2>
    <p id="who"></p>
    <p id="welcomeMessage">âœ¨ Welcome to your secret garden of poems, where every word is a whisper of love âœ¨</p>
    <button class="btn" id="logoutBtn">Logout</button>
    <div class="tabs">
      <div class="tab active" id="writeTab">Write</div>
      <div class="tab" id="viewTab">View</div>
    </div>
    <div class="section active" id="writeSection">
      <textarea id="poemInput" placeholder="Write your heart out..."></textarea>
      <button class="btn" id="saveBtn">Save</button>
      <button class="btn" id="clearBtn">Clear</button>
    </div>
    <div class="section" id="viewSection">
      <div id="poemsList"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="poemModal">
    <div class="inner">
      <span id="modalClose">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, query, orderByChild, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
       apiKey: "AIzaSyAkeuQLGRyARWRl-fyEeZWvATTcSt6mQMQ",
       authDomain: "keyupoemverse.firebaseapp.com",
       databaseURL: "https://keyupoemverse-default-rtdb.firebaseio.com",
       projectId: "keyupoemverse",
       storageBucket: "keyupoemverse.firebasestorage.app",
       messagingSenderId: "445792490698",
       appId: "1:445792490698:web:d295459f30ea921f79d033"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loginCard = document.getElementById('loginCard');
    const appCard   = document.getElementById('appCard');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const errEl     = document.getElementById('loginError');
    const whoEl     = document.getElementById('who');
    const welcomeEl = document.getElementById('welcomeMessage');

    const writeTab  = document.getElementById('writeTab');
    const viewTab   = document.getElementById('viewTab');
    const writeSec  = document.getElementById('writeSection');
    const viewSec   = document.getElementById('viewSection');

    const poemInput = document.getElementById('poemInput');
    const saveBtn   = document.getElementById('saveBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const poemsList = document.getElementById('poemsList');

    const poemModal = document.getElementById('poemModal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');

    function setTab(which){
      if(which === 'write'){
        writeTab.classList.add('active'); viewTab.classList.remove('active');
        writeSec.classList.add('active'); viewSec.classList.remove('active');
      }else{
        viewTab.classList.add('active'); writeTab.classList.remove('active');
        viewSec.classList.add('active'); writeSec.classList.remove('active');
      }
    }
    writeTab.addEventListener('click', () => setTab('write'));
    viewTab.addEventListener('click', () => setTab('view'));

    loginBtn.addEventListener('click', async () => {
      errEl.textContent = "";
      try{
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim());
      }catch(e){ errEl.textContent = e.message || "Login failed"; }
    });
    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if(user){
        loginCard.style.display = 'none';
        appCard.style.display = 'block';
        whoEl.textContent = `Signed in as: ${user.email}`;
        welcomeEl.style.display = "block"; // show welcome message
        startRealtimeListener();
      }else{
        appCard.style.display = 'none';
        loginCard.style.display = 'block';
        poemsList.innerHTML = "";
      }
    });

    saveBtn.addEventListener('click', async () => {
      const text = poemInput.value.trim();
      if(!text) return;
      const user = auth.currentUser;
      if(!user){ alert("Please login first."); return; }
      const poemsRef = ref(db, 'poems');
      const newRef = push(poemsRef);
      await set(newRef, { text, authorUid: user.uid, authorEmail: user.email, timestamp: Date.now() });
      poemInput.value = "";
      setTab('view');
    });
    clearBtn.addEventListener('click', () => poemInput.value = "");

    let subscribed = false;
    function startRealtimeListener(){
      if(subscribed) return; subscribed = true;
      const qRef = query(ref(db, 'poems'), orderByChild('timestamp'));
      onValue(qRef, (snap) => {
        const data = snap.val() || {};
        const items = Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp);
        renderPoems(items);
      });
    }

    function renderPoems(items){
      const me = auth.currentUser?.uid;
      poemsList.innerHTML = "";
      if(items.length === 0){
        poemsList.innerHTML = `<div class="empty">No poems yet. Be the first to write one âœ¨</div>`;
        return;
      }
      for(const [id, poem] of items){
        const el = document.createElement('div');
        el.className = 'poem';
        const d = poem.timestamp ? new Date(poem.timestamp) : null;
        const dateStr = d ? d.toLocaleString('en-IN', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
        el.innerHTML = `
          <div style="white-space:pre-wrap; line-height:1.55; color:#0e1f44">${escapeHTML(poem.text)}</div>
          <div class="meta">
            <span>by ${escapeHTML(poem.authorEmail || 'someone')}</span>
            ${dateStr ? `<span>â€¢ Written on ${dateStr}</span>` : ''}
          </div>`;
        el.addEventListener('click', () => {
          modalBody.innerHTML = el.innerHTML;
          poemModal.style.display = 'flex';
        });
        if(me && poem.authorUid === me){
          const del = document.createElement('button');
          del.className = 'delete';
          del.textContent = 'Delete';
          del.addEventListener('click', async (e) => {
            e.stopPropagation();
            if(confirm('Delete this poem? ðŸ’”')){
              await set(ref(db, 'poems/' + id), null);
            }
          });
          const edit = document.createElement('button');
          edit.className = 'edit';
          edit.textContent = 'Edit';
          edit.addEventListener('click', async (e) => {
            e.stopPropagation();
            const newText = prompt('Edit your poem:', poem.text);
            if(newText && newText.trim()){
              await update(ref(db, 'poems/' + id), { text:newText.trim() });
            }
          });
          el.appendChild(del);
          el.appendChild(edit);
        }
        poemsList.appendChild(el);
      }
    }

    modalClose.onclick = () => { poemModal.style.display = 'none'; };
    window.onclick = (e) => { if(e.target === poemModal) poemModal.style.display = 'none'; };

    function escapeHTML(str){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    const heartsLayer = document.getElementById('heartsLayer');
    function spawnHeart(){
      const h = document.createElement('div');
      h.className = 'heart';
      h.textContent = Math.random() > 0.5 ? 'ðŸ’™' : 'ðŸ¤';
      h.style.left = Math.random()*100 + 'vw';
      h.style.bottom = '-40px';
      h.style.fontSize = (16 + Math.random()*28) + 'px';
      heartsLayer.appendChild(h);
      setTimeout(() => h.remove(), 7000);
    }
    setInterval(spawnHeart, 350);
  </script>
</body>
</html>
