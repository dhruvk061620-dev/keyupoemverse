<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kriya's Poems House</title>
  <style>
    body {
      margin: 0;
      font-family: 'Georgia', serif;
      background: #f0f4ff;
      color: #0e1f44;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(135deg, #0a5bd3, #3399ff);
      color: white;
      text-align: center;
      padding: 1.5rem;
      font-size: 1.8rem;
      font-weight: bold;
    }
    /* âœ¨ Romantic welcome message styling */
    .welcome {
      text-align: center;
      font-size: 1.3rem;
      color: #444;
      margin: 1rem auto 2rem;
      font-style: italic;
      max-width: 700px;
      padding: 0 1rem;
      animation: fadeIn 3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .container { padding: 1.5rem; max-width: 800px; margin: auto; }
    .card {
      background: white;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .tabs { display: flex; margin-bottom: 1rem; border-bottom: 2px solid #ccc; }
    .tab {
      flex: 1; text-align: center; padding: 0.7rem; cursor: pointer;
      font-weight: bold; color: #0a5bd3;
    }
    .tab.active { border-bottom: 3px solid #0a5bd3; color: #004080; }
    .section { display: none; }
    .section.active { display: block; }
    textarea {
      width: 100%; min-height: 120px;
      padding: 0.7rem; font-size: 1rem;
      border-radius: 8px; border: 1px solid #ccc; resize: vertical;
    }
    button {
      padding: 0.6rem 1.2rem; margin-top: 0.8rem;
      border: none; border-radius: 8px;
      font-weight: bold; cursor: pointer;
      background: #0a5bd3; color: white;
    }
    button:hover { background: #004080; }
    .poem {
      padding: 1rem; border-bottom: 1px solid #eee;
      position: relative; background: #fafcff;
      border-radius: 8px; margin-bottom: 1rem;
      cursor: pointer;
    }
    .poem .meta {
      font-size: 0.85rem; color: #666; margin-top: 0.4rem;
    }
    .poem button {
      position: absolute; top: 8px; right: 8px;
      padding: 0.3rem 0.6rem; font-size: 0.8rem;
      border-radius: 6px;
    }
    .poem button.delete { background: crimson; }
    .poem button.edit { background: seagreen; right: 65px; }
    .poem button:hover { opacity: 0.8; }
    #poemModal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
    }
    #poemModal .modal-content {
      background: white; padding: 1.5rem; border-radius: 10px;
      max-width: 600px; width: 90%; max-height: 80vh;
      overflow-y: auto;
    }
    #modalClose {
      position: absolute; top: 10px; right: 20px;
      font-size: 1.5rem; cursor: pointer;
    }
    #heartsLayer {
      position: fixed; top:0; left:0; width:100%; height:100%;
      pointer-events: none; overflow:hidden; z-index: 0;
    }
    .heart {
      position: absolute; bottom: -40px; font-size: 24px;
      animation: floatUp 7s linear forwards;
    }
    @keyframes floatUp {
      from { transform: translateY(0) scale(1); opacity: 1; }
      to   { transform: translateY(-110vh) scale(1.8); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>Kriya's Poems House</header>

  <!-- âœ¨ Romantic Welcome Message -->
  <div class="welcome">
    Welcome, my love ðŸ’– Every word written here is a little piece of my heart,  
    floating to you like these blue and white hearts in the sky.
  </div>

  <div class="container">
    <!-- login card -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <input id="email" placeholder="Email"><br><br>
      <input id="password" type="password" placeholder="Password"><br><br>
      <button id="loginBtn">Login</button>
      <p id="loginError" style="color:red;"></p>
    </div>

    <!-- app card -->
    <div id="appCard" class="card" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Poems</h2>
        <button id="logoutBtn">Logout</button>
      </div>
      <p id="who"></p>
      <div class="tabs">
        <div id="writeTab" class="tab active">Write</div>
        <div id="viewTab" class="tab">Read</div>
      </div>
      <div id="writeSection" class="section active">
        <textarea id="poemInput" placeholder="Write your poem..."></textarea><br>
        <button id="saveBtn">Save</button>
        <button id="clearBtn">Clear</button>
      </div>
      <div id="viewSection" class="section">
        <div id="poemsList"></div>
      </div>
    </div>
  </div>

  <!-- poem modal -->
  <div id="poemModal">
    <div class="modal-content">
      <span id="modalClose">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- floating hearts layer -->
  <div id="heartsLayer"></div>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, query, orderByChild, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
       apiKey: "AIzaSyAkeuQLGRyARWRl-fyEeZWvATTcSt6mQMQ",
       authDomain: "keyupoemverse.firebaseapp.com",
       databaseURL: "https://keyupoemverse-default-rtdb.firebaseio.com",
       projectId: "keyupoemverse",
       storageBucket: "keyupoemverse.firebasestorage.app",
       messagingSenderId: "445792490698",
       appId: "1:445792490698:web:d295459f30ea921f79d033"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loginCard = document.getElementById('loginCard');
    const appCard   = document.getElementById('appCard');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const errEl     = document.getElementById('loginError');
    const whoEl     = document.getElementById('who');

    const writeTab  = document.getElementById('writeTab');
    const viewTab   = document.getElementById('viewTab');
    const writeSec  = document.getElementById('writeSection');
    const viewSec   = document.getElementById('viewSection');

    const poemInput = document.getElementById('poemInput');
    const saveBtn   = document.getElementById('saveBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const poemsList = document.getElementById('poemsList');

    const poemModal = document.getElementById('poemModal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');

    function setTab(which){
      if(which === 'write'){
        writeTab.classList.add('active'); viewTab.classList.remove('active');
        writeSec.classList.add('active'); viewSec.classList.remove('active');
      }else{
        viewTab.classList.add('active'); writeTab.classList.remove('active');
        viewSec.classList.add('active'); writeSec.classList.remove('active');
      }
    }
    writeTab.addEventListener('click', () => setTab('write'));
    viewTab.addEventListener('click', () => setTab('view'));

    loginBtn.addEventListener('click', async () => {
      errEl.textContent = "";
      try{
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim());
      }catch(e){ errEl.textContent = e.message || "Login failed"; }
    });
    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if(user){
        loginCard.style.display = 'none';
        appCard.style.display = 'block';
        whoEl.textContent = `Signed in as: ${user.email}`;
        startRealtimeListener();
      }else{
        appCard.style.display = 'none';
        loginCard.style.display = 'block';
        poemsList.innerHTML = "";
      }
    });

    saveBtn.addEventListener('click', async () => {
      const text = poemInput.value.trim();
      if(!text) return;
      const user = auth.currentUser;
      if(!user){ alert("Please login first."); return; }
      const poemsRef = ref(db, 'poems');
      const newRef = push(poemsRef);
      await set(newRef, { text, authorUid: user.uid, authorEmail: user.email, timestamp: Date.now() });
      poemInput.value = "";
      setTab('view');
    });
    clearBtn.addEventListener('click', () => poemInput.value = "");

    let subscribed = false;
    function startRealtimeListener(){
      if(subscribed) return; subscribed = true;
      const qRef = query(ref(db, 'poems'), orderByChild('timestamp'));
      onValue(qRef, (snap) => {
        const data = snap.val() || {};
        const items = Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp);
        renderPoems(items);
      });
    }

    function renderPoems(items){
      const me = auth.currentUser?.uid;
      poemsList.innerHTML = "";
      if(items.length === 0){
        poemsList.innerHTML = `<div class="empty">No poems yet. Be the first to write one âœ¨</div>`;
        return;
      }
      for(const [id, poem] of items){
        const el = document.createElement('div');
        el.className = 'poem';
        const d = poem.timestamp ? new Date(poem.timestamp) : null;
        const dateStr = d ? d.toLocaleString('en-IN', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
        el.innerHTML = `
          <div style="white-space:pre-wrap; line-height:1.55; color:#0e1f44">${escapeHTML(poem.text)}</div>
          <div class="meta">
            <span>by ${escapeHTML(poem.authorEmail || 'someone')}</span>
            ${dateStr ? `<span>â€¢ Written on ${dateStr}</span>` : ''}
          </div>`;
        el.addEventListener('click', () => {
          modalBody.innerHTML = el.innerHTML;
          poemModal.style.display = 'flex';
        });
        if(me && poem.authorUid === me){
          const del = document.createElement('button');
          del.className = 'delete';
          del.textContent = 'Delete';
          del.addEventListener('click', async (e) => {
            e.stopPropagation();
            if(confirm('Delete this poem? ðŸ’”')){
              await set(ref(db, 'poems/' + id), null);
            }
          });
          const edit = document.createElement('button');
          edit.className = 'edit';
          edit.textContent = 'Edit';
          edit.addEventListener('click', async (e) => {
            e.stopPropagation();
            const newText = prompt('Edit your poem:', poem.text);
            if(newText && newText.trim()){
              await update(ref(db, 'poems/' + id), { text:newText.trim() });
            }
          });
          el.appendChild(del);
          el.appendChild(edit);
        }
        poemsList.appendChild(el);
      }
    }

    modalClose.onclick = () => { poemModal.style.display = 'none'; };
    window.onclick = (e) => { if(e.target === poemModal) poemModal.style.display = 'none'; };

    function escapeHTML(str){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    const heartsLayer = document.getElementById('heartsLayer');
    function spawnHeart(){
      const h = document.createElement('div');
      h.className = 'heart';
      h.textContent = Math.random() > 0.5 ? 'ðŸ’™' : 'ðŸ¤';
      h.style.left = Math.random()*100 + 'vw';
      h.style.bottom = '-40px';
      h.style.fontSize = (16 + Math.random()*28) + 'px';
      heartsLayer.appendChild(h);
      setTimeout(() => h.remove(), 7000);
    }
    setInterval(spawnHeart, 350);
  </script>
</body>
</html>
